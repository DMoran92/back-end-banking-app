<!DOCTYPE HTML>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{webjars/bootstrap/4.2.1/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body{
            /*padding-top: 50px;*/
            background-color:lightblue;
        }

        .banner {
            font-size:30px;
            font-weight:bolder;
            vertical-align: text-top;
        }

        .toolbar-item{
            font-size:20px;
        }

        h1{
            color:darkblue;
        }

        h2{
            color:yellow;
        }

        a{
            color:black;
            text-decoration:underline;
        }
        #sidebar-nav{
            width:260px;
            background-color:lightgrey;
        }

        .toolbars {
            background-color: lightgrey;
        }

        .icon-60 { font-size: 60px; }
        .icon-100 { font-size: 100px; }
        .icon-200 { font-size: 200px; }
        .icon-300 { font-size: 300px; }

    </style>
    <script>
        // Function to make a fetch request with included credentials (cookies)
        // https://javascript.info/fetch-crossorigin#credentials
        // https://developer.mozilla.org/en-US/docs/Web/API/fetch#credentials
        // if we don't have this we get 403 sometimes
        async function fetchWithToken(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                credentials: 'include' // Ensure cookies are included in the request
            });
            if (!response.ok) {
                showErrorModal('Network response was not ok: ' + response.statusText); // will need to provide proper error msg
                //throw new Error('Network response was not ok ' + response.statusText);

            }
            return response.json();
        }

        async function loadDashboard() {
            try {
                const data = await fetchWithToken('/dashboard/');
                console.log('Fetched data:', data); // Log the fetched data for debugging
                populateDashboard(data);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard!');
            }
        }

        function populateDashboard(data) {
            // Populate customer details
            if (data.customer && data.customer.firstName && data.customer.lastName && data.customer.accounts) {
                document.getElementById('customer-details').innerHTML = `
                    <tr>
                        <td>${data.customer.firstName}</td>
                        <td>${data.customer.lastName}</td>
                        <td>${data.customer.accounts[0].balance}</td>
                    </tr>
                `;
            } else {
                console.error('Customer data is missing or malformed', data);
            }

            let notNullRecipientIBAN = "";
            // Populate transactions
            if (data.accountTransactions) {
                //if (!data.accountTransactions.map(transaction => transaction.recipientIBAN == null)){
                  //  notNullRecipientIBAN = transaction.recipientIBAN;
                    const outTransactionsHtml = data.accountTransactions.filter(t => t.recipientIBAN != null).map(transaction => `
                        <tr>
                            <td>${transaction.recipientIBAN}</td>
                            <td>${transaction.amount}</td>
                            <td>${transaction.timestamp}</td>
                        </tr>
                    `).join('');

                //}

                const inTransactionsHtml = data.accountTransactions.filter(t => t.senderIBAN != null).map(transaction => `
                    <tr>
                        <td>${transaction.senderIBAN}</td>
                        <td>${transaction.amount}</td>
                        <td>${transaction.timestamp}</td>
                    </tr>
                `).join('');

                document.getElementById('transactionsOut').innerHTML = outTransactionsHtml;
                document.getElementById('transactionsIn').innerHTML = inTransactionsHtml;
            } else {
                console.error('Transaction data is missing or malformed', data);
            }
        }
        /* pop a error modal if something goes wrong, probably will need better error handling (more user friendly */
        function showErrorModal(message) {
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'), {});
            document.getElementById('errorModalBody').innerText = message;
            errorModal.show();
        }

        async function makeTransaction(event){
            // prevent default submission behaviour
            event.preventDefault();
            // Get the customer ID and password from the form fields
            const amount = document.getElementById('amount').value;
            const recipientIBAN = document.getElementById('recipientIBAN').value;

            // Make a POST request to the /api/authenticate endpoint
            const response = await fetch('/dashboard/makeTransaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // Convert the username and password to a JSON string and include it in the request body
                body: JSON.stringify({ amount: amount, recipientIBAN: recipientIBAN })
            });
            // If the response is OK, redirect to the dashboard page
            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                alert('transfer failed');
            }
        }

        window.onload = loadDashboard;
    </script>
</head>

<body>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/cdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<nav class="navbar navbar-expand-lg navbar-light fixed-top flex-md-nowrap p-0 shadow">
    <div class="container-fluid toolbars">
        <a class="navbar-brand banner align-middle" href="/"><i class="bi bi-bank icon-60"></i>   Bank of Galway</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            </ul>
            <form class="d-flex">
                <input class="form-control me-2 toolbar-item" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row flex-nowrap">
        <div class="col-auto px-0"  style="height: 100%">
            <div id="sidebar" class="collapse collapse-horizontal show border-end">
                <div id="sidebar-nav" class="list-group border-0 rounded-0 text-sm-start min-vh-100" style="background-color: lightgrey">
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-parent="#sidebar"></a>
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-parent="#sidebar"></a>
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate h1" data-bs-parent="#sidebar"></a>
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate h1" data-bs-parent="#sidebar"></a>
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate h1" data-bs-parent="#sidebar"></a>
                    <a style="background-color:lightgrey" href="#" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-parent="#sidebar"><i class="bi bi-question-diamond"></i> <span>Trasaction Enquiry</span></a>
                    <a style="background-color:lightgrey" href="#" data-bs-toggle="modal" data-bs-target="#transferModal" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-parent="#sidebar"><i class="bi bi-arrow-left-right"></i> <span>Transfer Funds</span></a>
                </div>
            </div>
        </div>
        <main class="col ps-md-2 pt-2">
            <br/>
            <br/>
            <br/>
            <br/>
            <div class="row">
                <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                    <div class="card">
                        <h5 class="card-header">Customer Details</h5>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Account Balance</th>
                                    </tr>
                                    </thead>
                                    <tbody id="customer-details">
                                    <!-- Customer details will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                    <div class="card">
                        <h5 class="card-header">Latest Outgoing Transactions</h5>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Recipient</th>
                                        <th>Amount Sent</th>
                                        <th>Date & Time of Transaction</th>
                                    </tr>
                                    </thead>
                                    <tbody id="transactionsOut">
                                    <!-- Transactions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                    <div class="card">
                        <h5 class="card-header">Latest Incoming Transactions</h5>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Sent From</th>
                                        <th>Amount Sent</th>
                                        <th>Date & Time of Transaction</th>
                                    </tr>
                                    </thead>
                                    <tbody id="transactionsIn">
                                    <!-- Transactions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="transferModalLabel">Send Money</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="makeTransactionForm" onsubmit="makeTransaction(event)">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount To Send</label>
                        <input type="number" class="form-control" id="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipientIBAN" class="form-label">Recipient IBAN</label>
                        <input type="text" class="form-control" id="recipientIBAN" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
-->
<!-- Error Modal used to display errors -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <!-- Error message will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Load jQuery first -->
<script src="/webjars/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" th:src="@{webjars/bootstrap/4.2.1/js/bootstrap.min.js}"></script>
</body>
</html>