<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{webjars/bootstrap/5.2.3/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body{
            /*padding-top: 50px;*/
            background-color:lightblue;
        }

        .banner {
            font-size:30px;
            font-weight:bolder;
            vertical-align: text-top;
        }

        .toolbar-item{
            font-size:20px;
        }

        h1{
            color:darkblue;
        }

        h2{
            color:yellow;
        }

        a{
            color:black;
            text-decoration:underline;
        }
        #sidebar-nav{
            padding-top: 95px;
            width:260px;
            background-color:lightgrey;
        }

        .toolbars {
            background-color: lightgrey;
        }

        .icon-60 { font-size: 60px; }
        .icon-100 { font-size: 100px; }
        .icon-200 { font-size: 200px; }
        .icon-300 { font-size: 300px; }
    </style>
    <script>
        // Initialize a global variable to store the customerID
        var customerID = null;

        // Function to make a fetch request with included credentials (cookies)
        // https://javascript.info/fetch-crossorigin#credentials
        // https://developer.mozilla.org/en-US/docs/Web/API/fetch#credentials
        // if we don't have this we get 403 sometimes
        async function fetchWithToken(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                credentials: 'include' // Ensure cookies are included in the request
            });

            // This is done this way, because we either return json as a response or a string literal.
            // You can only read the response body once, so we need to check the content type first and read the
            // correct body type. If we try to parse json first and then if it fails read the string, its already empty
            // and will fail.
            // https://stackoverflow.com/questions/37121301/how-to-check-if-the-response-of-a-fetch-is-a-json-object-in-javascript
            let responseBody;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                responseBody = await response.json(); // Attempt to parse the response as JSON
            } else {
                responseBody = await response.text(); // Fallback to text if JSON parsing fails
            }

            if (!response.ok) {
                showErrorModal('Network response was not ok: ' + response.statusText + ' - ' + responseBody);
                throw new Error('Network response was not ok: ' + response.statusText + ' - ' + responseBody);
            }
            return responseBody;
        }

        async function loadDashboard() {
            try {
                const data = await fetchWithToken('/dashboard/');
                console.log('Fetched data:', data); // Log the fetched data for debugging
                populateDashboard(data);
                // Set the global customerID variable
                customerID = data.customer.customerId;
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard!');
            }
        }

        function populateDashboard(data) {
            // Populate customer details
            if (data.customer && data.customer.firstName && data.customer.lastName && data.customer.accounts) {
                document.getElementById('customer-details').innerHTML = `
                    <tr>
                        <td>${data.customer.firstName}</td>
                        <td>${data.customer.lastName}</td>
                        <td>${data.customer.accounts[0].balance}</td>
                    </tr>
                `;
            } else {
                console.error('Customer data is missing or malformed', data);
            }

            // Populate transactions
            if (data.accountTransactions) {
                const outTransactionsHtml = data.accountTransactions.filter(t => t.recipientIBAN != null).map(transaction => `
                        <tr>
                            <td>${transaction.recipientIBAN}</td>
                            <td>${transaction.amount}</td>
                            <td>${transaction.category}</td>
                            <td>${transaction.timestamp}</td>
                        </tr>
                    `).join('');

                const inTransactionsHtml = data.accountTransactions.filter(t => t.senderIBAN != null).map(transaction => `
                    <tr>
                        <td>${transaction.senderName}</td>
                        <td>${transaction.amount}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.timestamp}</td>
                    </tr>
                `).join('');

                document.getElementById('transactionsOut').innerHTML = outTransactionsHtml;
                document.getElementById('transactionsIn').innerHTML = inTransactionsHtml;
            } else {
                console.error('Transaction data is missing or malformed', data);
            }
        }
        /* pop an error modal if something goes wrong, probably will need better error handling (more user friendly */
        function showErrorModal(message) {
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'), {});
            document.getElementById('errorModalBody').innerText = message;
            errorModal.show();
        }

        async function addFavouritePayee(event) {
            event.preventDefault();
            const name = document.getElementById('payeeName').value;
            const iban = document.getElementById('payeeIban').value;

            try {
                const response = await fetchWithToken(`/api/favourite-payees/add?customerId=${customerID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name, iban: iban })
                });

                await loadFavouritePayees(); // Refresh the list of favourite payees
            } catch (error) {
                console.error('Error adding payee:', error);
                alert('add payee failed: ' + error.message);
            }
        }

        async function removeFavouritePayee(payeeId) {
            try {
                const response = await fetchWithToken(`/api/favourite-payees/remove?payeeId=${payeeId}`, {
                    method: 'DELETE',
                });
                await loadFavouritePayees(); // Refresh the list of favourite payees
            } catch (error) {
                console.error('Error removing payee:', error);
                showErrorModal('Failed to remove favourite payee. Please try again later.')
            }
        }

        async function loadFavouritePayees() {
            try {
                const data = await fetchWithToken('/api/favourite-payees');
                populateFavouritePayees(data);
            } catch (error) {
                console.error('Error loading favourite payees:', error);
                showErrorModal('Failed to remove favourite payee. Please try again later.')
            }
        }
        function populateFavouritePayees(data) {
            const payeesHtml = data.map(payee => `
                <tr>
                    <td>${payee.name}</td>
                    <td>${payee.iban}</td>
                    <td><button onclick="removeFavouritePayee(${payee.id})" class="btn btn-danger">Remove</button></td>
                </tr>
            `).join('');
            document.getElementById('favoritePayeesList').innerHTML = payeesHtml;
        }

        async function loadCards() {
            try {
                const cards = await fetchWithToken('/api/cards', {
                    method: 'GET'
                });
                const cardList = document.getElementById('cardList');
                cardList.innerHTML = '';
                cards.forEach(card => {
                    let buttonsHtml;
                    if (card.status === 'Stolen') {
                        buttonsHtml = `
                            <button class="btn btn-secondary" disabled>Freeze card</button>
                            <button class="btn btn-secondary" disabled>Stolen</button>`;
                    } else {
                        const freezeButton = card.status === 'Frozen' ?
                            `<button class="btn btn-success" onclick="unfreezeCard(${card.cardId})">Unfreeze Card</button>` :
                            `<button class="btn btn-warning" onclick="freezeCard(${card.cardId})">Freeze Card</button>`;
                        buttonsHtml = `
                            ${freezeButton}
                            <button class="btn btn-danger" onclick="reportStolen(${card.cardId})">Report Stolen</button>`;
                    }
                    cardList.innerHTML += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <p class="card-text"><strong>Card Number:</strong> ${card.cardNumber}</p>
                                <p class="card-text"><strong>Expiry Date:</strong> ${card.expiryDate}</p>
                                <p class="card-text"><strong>Status:</strong> ${card.status}</p>
                                ${buttonsHtml}
                            </div>
                        </div>
                        `;
                });
            } catch (error) {
                console.error('Error loading cards:', error);
                showErrorModal('Failed to load cards {}', error);
            }
        }

        async function orderNewCard() {
            try {
                const response = await fetchWithToken('/api/cards/order', {
                    method: 'POST'
                });
                loadCards();
            } catch (error) {
                console.error('Error ordering new card:', error);
                showErrorModal('Order new card failed: ' + error.message);
            }
        }

        function showOrderCardConfirmation() {
            const orderCardModal = new bootstrap.Modal(document.getElementById('orderCardModal'), {});
            orderCardModal.show();
        }

        async function freezeCard(cardId) {
            try {
                await fetchWithToken(`/api/cards/freeze?id=${cardId}`, {
                    method: 'PUT'
                });
                loadCards();
            } catch (error) {
                console.error('Error freezing card:', error);
                showErrorModal('Failed to freeze card {}', error);
            }
        }

        async function unfreezeCard(cardId) {
            try {
                await fetchWithToken(`/api/cards/unfreeze?id=${cardId}`, {
                    method: 'PUT'
                });
                loadCards();
            } catch (error) {
                console.error('Error unfreezing card:', error);
                showErrorModal('Failed to unfreeze card {}', error);
            }
        }

        async function reportStolen(cardId) {
            try {
                await fetchWithToken(`/api/cards/report-stolen?id=${cardId}`, {
                    method: 'PUT'
                });
                alert('Card reported stolen successfully');
                loadCards();
            } catch (error) {
                console.error('Error reporting card stolen:', error);
                showErrorModal('Failed to report stolen card {}', error);
            }
        }

        async function makeTransaction(event){
            // prevent default submission behaviour
            event.preventDefault();
            // Get the customer ID and password from the form fields
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const recipientIBAN = document.getElementById('recipientIBAN').value;

            // Make a POST request to the /api/authenticate endpoint
            const response = await fetch('/transaction/makeTransaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // Convert the username and password to a JSON string and include it in the request body
                body: JSON.stringify({ amount: amount, recipientIBAN: recipientIBAN, category: category })
            });
            // If the response is OK, redirect to the dashboard page
            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                alert('transfer failed');
            }
        }

        async function makeAccount(event){
            // prevent default submission behaviour
            event.preventDefault();
            // Get the customer ID and password from the form fields
            const accountType = document.getElementById('accountType').value;

            // Make a POST request to the /api/authenticate endpoint
            const response = await fetch('/dashboard/makeAccount/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // Convert the username and password to a JSON string and include it in the request body
                body: JSON.stringify({ accountType: accountType })
            });
            // If the response is OK, redirect to the dashboard page
            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                alert('creation failed');
            }
        }

        window.onload = function() {
            loadDashboard();
            loadFavouritePayees();
            loadCards();
        };
    </script>
</head>

<body>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cdbootstrap/js/cdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<nav class="navbar navbar-expand-lg navbar-light fixed-top flex-md-nowrap p-0 shadow">
    <div class="container-fluid toolbars">
        <a class="navbar-brand banner align-middle" href="/"><i class="bi bi-bank icon-60"></i>   Bank of Galway</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            </ul>
            <form class="d-flex">
                <input class="form-control me-2 toolbar-item" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row flex-nowrap">
        <div class="col-auto px-0"  style="height: 100%">
            <div id="sidebar" class="collapse collapse-horizontal show border-end">
                <div id="sidebar-nav" class="list-group border-0 rounded-0 text-sm-start min-vh-100" style="background-color: lightgrey">
                    <a style="background-color:lightgrey" href="#home" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-house"></i> <span>Home</span></a>
                    <a style="background-color:lightgrey" href="#transaction-enquiry" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-question-diamond"></i> <span>Transaction Enquiry</span></a>
                    <a style="background-color:lightgrey" href="#transfer-funds" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-arrow-left-right"></i> <span>Transfer Funds</span></a>
                    <a style="background-color:lightgrey" href="#pay-bill" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-file-ruled"></i> <span>Pay a Bill</span></a>
                    <a style="background-color:lightgrey" href="#create-account" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-file-plus"></i> <span>Create a New Account</span></a>
                    <a style="background-color:lightgrey" href="#request-statements" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-file-text"></i> <span>Request Statements</span></a>
                    <a style="background-color:lightgrey" href="#order-card" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-credit-card"></i> <span>Card Management</span></a>
                    <a style="background-color:lightgrey" href="#manage-payees" class="list-group-item border-end-0 d-inline-block text-truncate" data-bs-toggle="tab"><i class="bi bi-people"></i> <span>Manage Payees</span></a>
                </div>
            </div>
        </div>
        <main class="col ps-md-2 pt-2">
            <br/>
            <br/>
            <br/>
            <br/>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                    <div class="row">
                        <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                            <div class="card">
                                <h5 class="card-header">Customer Details</h5>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th>First Name</th>
                                                <th>Last Name</th>
                                                <th>Account Balance</th>
                                            </tr>
                                            </thead>
                                            <tbody id="customer-details">
                                            <!-- Customer details will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="transaction-enquiry" role="tabpanel">
                    <h2>Transaction Enquiry</h2><div class="row">
                    <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                        <div class="card">
                            <h5 class="card-header">Latest Outgoing Transactions</h5>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>Recipient</th>
                                            <th>Amount Sent</th>
                                            <th>Category</th>
                                            <th>Date & Time of Transaction</th>
                                        </tr>
                                        </thead>
                                        <tbody id="transactionsOut">
                                        <!-- Transactions will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-xl-6 mb-4 mb-lg-0">
                        <div class="card">
                            <h5 class="card-header">Latest Incoming Transactions</h5>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>Sent From</th>
                                            <th>Amount Received</th>
                                            <th>Category</th>
                                            <th>Date & Time of Transaction</th>
                                        </tr>
                                        </thead>
                                        <tbody id="transactionsIn">
                                        <!-- Transactions will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <div class="tab-pane fade" id="transfer-funds" role="tabpanel">
                    <h2>Transfer Funds</h2>
                    <form id="makeTransactionForm" onsubmit="makeTransaction(event)">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount To Send</label>
                            <input type="number" class="form-control" id="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">Transaction Category</label>
                            <input type="text" class="form-control" id="category" required>
                        </div>
                        <div class="mb-3">
                            <label for="recipientIBAN" class="form-label">Recipient IBAN</label>
                            <input type="text" class="form-control" id="recipientIBAN" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="pay-bill" role="tabpanel">
                    <h2>Pay a Bill</h2>
                    <p>Content for Pay a Bill</p>
                </div>
                <div class="tab-pane fade" id="create-account" role="tabpanel">
                    <h2>Create a New Account</h2>
                    <form id="makeAccountForm" onsubmit="makeAccount(event)">
                        <div class="mb-3">
                            <label for="accountType" class="form-label">Enter Account Type To Make</label>
                            <input type="text" class="form-control" id="accountType" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="request-statements" role="tabpanel">
                    <h2>Request Statements</h2>
                    <p>Content for Request Statements</p>
                </div>
                <!-- adding card management Order/Freeze/Report Stolen -->
                <div class="tab-pane fade" id="order-card" role="tabpanel">
                    <p>Manage your payment cards below.</p>
                    <!-- Section to display cards -->
                    <div class="card mt-4">
                        <div class="card-header">
                            Your Cards
                        </div>
                        <div class="card-body" id="cardList">
                            <!-- Cards will be populated here -->
                        </div>
                    </div>
                    <!-- Section to order a new card -->
                    <div class="card mt-4">
                        <div class="card-header">
                            Order New Card
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-primary" onclick="showOrderCardConfirmation()">Order New Card</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="manage-payees" role="tabpanel">
                    <h2>Add Favourite Payee</h2>
                    <form id="addFavouritePayeeForm" onsubmit="addFavouritePayee(event)">
                        <label for="payeeName">Name:</label>
                        <input type="text" id="payeeName" name="payeeName" required>
                        <label for="payeeIban">IBAN:</label>
                        <input type="text" id="payeeIban" name="payeeIban" required>
                        <button type="submit">Add Payee</button>
                    </form>
                    <h2>Favourite Payees</h2>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Name</th>
                                <th>IBAN</th>
                            </tr>
                            </thead>
                            <tbody id="favoritePayeesList">
                            <!-- Favorite payees will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>


<!-- Order Card Confirmation Modal -->
<div class="modal fade" id="orderCardModal" tabindex="-1" aria-labelledby="orderCardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderCardModalLabel">Order New Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to order a new card?</p>
                <p>Charge: 9.99 Euro. Delivery: 5 working days.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="orderNewCard()" >Confirm</button>
            </div>
        </div>
    </div>
</div>


<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <!-- Error message will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Load jQuery first -->
<script src="/webjars/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" th:src="@{webjars/bootstrap/5.2.3/js/bootstrap.min.js}"></script>
</body>
</html>
